<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Accounts Map</title>

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Zoho SDK (safe if not in Zoho) -->
  <script src="https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // ðŸ”‘ MAPBOX TOKEN (REPLACE WITH YOUR REAL TOKEN)
    mapboxgl.accessToken = "pk.eyJ1IjoibW9uYW1jY29ybWljayIsImEiOiJjbWs5c25rcmcwNmwyM2NwenB3d21kZGFzIn0.sTsW8a-JPa6n15Acuugg-Q";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [-98, 39],
      zoom: 4
    });

    function isZoho() {
      return typeof window.ZOHO !== "undefined";
    }

    async function loadPins() {
      if (!isZoho()) {
        console.log("Public mode â€” no data loaded");
        return;
      }

      await ZOHO.embeddedApp.init();
      const token = await ZOHO.CRM.API.getAccessToken();

      const resp = await fetch(
        "https://mapapi-monamccormick.pythonanywhere.com/map/accounts",
        {
          headers: {
            Authorization: "Zoho-oauthtoken " + token
          }
        }
      );

      const pins = await resp.json();

      pins.forEach(p => {
        new mapboxgl.Marker()
          .setLngLat([p.lng, p.lat])
          .setPopup(new mapboxgl.Popup().setText(p.name))
          .addTo(map);
      });
    }

    map.on("load", loadPins);
  </script>
</body>
</html>
